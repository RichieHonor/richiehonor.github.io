---
title: "Assessing the prevalence and correlates of antenatal cannabis consumption in an urban Canadian population: A cross-sectional survey - Supplementary Material"
author: "Richard Honor"
date: "16/03/2020"
output: html_document
---

***Goal of Analysis***: Perform logistic regressions on cannabis consumption data with various demographic data as independent variables to determine which, if any factors, are associating with consuming cannabis during pregnancy or while breastfeeding. This document was also used to generate the tables and figures used in the paper and supplementary material. Lastly, a simulation was performed to generate confidence intervals used in the figure, and data from other cohorts were compared to our cohort. 

***Data structure***: These data were sampled in a survey format from pregnant women in Hamilton Ontario.  Participants are anonymous.

***Approach***: Generalized logistic regressions were performed with the function "glm" and a binomial distribution. Visualizations were performed with ggplot2.

***Notes***:

* Custom functions were created in this [accessory file](richiehonor.github.io/Kaarid_et_al_2021_SupplementaryMaterial.html/CanabPreg_Functions.html)

# Data preparation
```{r,results="hide",message=F}
library(ggplot2)
library(dplyr)
source("CanabPreg_Functions.R") #import custom functions from accessory file

#Load in Data
dat<-read.csv("CannabisAndPregnancy.csv",stringsAsFactors = F)


#Select only the columns we are interested in
dat3<-dat[,c(1,5,6,7,8,9,10,11,12,13)]

#Rename these columns
colnames(dat3)<-c("Recorder","Age","Education","Income","Relationship_Status","Ever_Smoked","Partner_Smoke","Partner_Smoke_While_Preg","Ever_Smoke_While_Preg","Smoke_Now")

#These collumns are subsetted and used for  descriptive statistics.
Usage=dat[,c(14:28)]

colnames(Usage)<-c("Use_Joint","Use_Bong","Use_Edible","Use_Oil","Use_Vaping","Type","How_Often","Reason_Nausea_Vomiting","Reason_Pain","Reason_Sleep","Reason_Anxiety","Reason_Social","Reason_Other_Check","Reason_Other","Smoke_Breastfeed")

#Merging the usage and dat3 dataframes together.
Usage=cbind(Usage,dat3)

#Adding breastfeeding data to the dat3 dataframe.
dat3$Smoke_breastfeed=Usage$Smoke_Breastfeed



##########
#CLEAN DATA
##########

#------
#Responce variables
#------
#Make response variable 1 or 0 (1= yes 0=no) to prepare for the logistic regressions.

 #Ever_Smoke_While_Preg 
for(i in 1:length(dat3$Ever_Smoke_While_Preg)){
 
  if(dat3$Ever_Smoke_While_Preg[i]=="Yes"){
    dat3$Ever_Smoke_While_Preg[i]<-1
  }
  if(dat3$Ever_Smoke_While_Preg[i]=="No"){
    dat3$Ever_Smoke_While_Preg[i]<-0
  }
  
}
dat3$Ever_Smoke_While_Preg=as.numeric(dat3$Ever_Smoke_While_Preg)

#Currently smoking cannabis
for(i in 1:length(dat3$Smoke_Now)){
  
  if(dat3$Smoke_Now[i]=="Yes"){
    dat3$Smoke_Now[i]<-1
  }
  if(dat3$Smoke_Now[i]=="No"){
    dat3$Smoke_Now[i]<-0
  }
  
}
dat3$Smoke_Now=as.numeric(dat3$Smoke_Now)



#----
#Explanatory Variables
#----
#Combining explanatory variables into desired categories


#Education: Elementary/Highschool, College/Tradeschool, University/Gradschool
unique(dat3$Education)
for(i in 1:length(dat3$Education)){
  
  #Elementary/Highschool
  if(dat3$Education[i]=="high school" | dat3$Education[i]=="elementary/middle school"){
    dat3$Education_Pooled[i]<-"Elementary/Highschool"
    next
  }
  
  #College/Tradeschool
    if(dat3$Education[i]=="college" | dat3$Education[i]=="trade schooling"){
    dat3$Education_Pooled[i]<-"College/Tradeschool"
    next
    }
  
    #University/Gradschool
    if(dat3$Education[i]=="university undergrad degree" | dat3$Education[i]=="graduate/professional school"){
    dat3$Education_Pooled[i]<-"University/Gradschool"
    next
    }
      else{
    print("something didnt work!!!")
    break 
  }
}
#Checking
data.frame(dat3$Education,dat3$Education_Pooled)


#Income: 0-40, 40-100, 100+
unique(dat3$Income)
for(i in 1:length(dat3$Income)){
  #0-40
  if(dat3$Income[i]=="under $20,000" | dat3$Income[i]=="$20,000 - $40,000"){
    dat3$Income_Pooled[i]<-"0-40"
    next
  }
  
  #40-100
    if(dat3$Income[i]=="$41,000 - $60,000" | dat3$Income[i]=="$61,000 - $80,000" | dat3$Income[i]=="$81,000 - $100,000"){
    dat3$Income_Pooled[i]<-"40-100"
    next
    }
  
    #100+
    if(dat3$Income[i]=="over $100,000"){
    dat3$Income_Pooled[i]<-"100+"
    next
    }
    
  else{
    print("something didnt work!!!")
    print(dat3$Income[i])
    print(i)
    break 
  }
}
#Checking
data.frame(dat3$Income,dat3$Income_Pooled)

#Relationship status
for(i in 1:length(dat3$Relationship_Status)){
  if(dat3$Relationship_Status[i]==""){
    dat3$Relationship_Status[i]=NA
  }
}


for(i in 1:length(dat3$Relationship_Status)){
    if(is.na(dat3$Relationship_Status[i])){
    dat3$Relationship_Status_Pooled[i]=NA
    next
    }
  
    if(dat3$Relationship_Status[i]=="married/common law/living together"){
    dat3$Relationship_Status_Pooled[i]="married/common law/living together"
    next
    }
  
  if(dat3$Relationship_Status[i]=="in a relationship but not living together" | dat3$Relationship_Status[i]=="single/divorced/widowed"){
    dat3$Relationship_Status_Pooled[i]="Single_Or_Dating"
    next
  }
  else{print("something went wrong");break}

}

#checking
data.frame(dat3$Relationship_Status,dat3$Relationship_Status_Pooled)


#----
#Replace missing data with NA
#----

#Does your partner smoke cannabis?
for(i in 1:length(dat3$Partner_Smoke)){
  if(dat3$Partner_Smoke[i]==""){
    dat3$Partner_Smoke[i]=NA
    next
  }
  if(dat3$Partner_Smoke[i]=="Yes"){
    next
  }
   if(dat3$Partner_Smoke[i]=="No"){
    next
  }
    if(is.na(dat3$Partner_Smoke[i])){
    next
    }
  else{print("something is wrong:");print(dat3$Partner_Smoke[i]);break}
}

#Are you currently smoking while pregnant? Missing answers are considered to be "No".
for(i in 1:length(dat3$Smoke_Now)){
  if(is.na(dat3$Smoke_Now[i])){
    dat3$Smoke_Now[i]=0
  }
}

#checking
unique(dat3$Relationship_Status)
unique(dat3$Partner_Smoke)
unique(dat3$Smoke_Now)

#------
#Generate new columns for variables of interest
#------

#create vector for if people did or did not report thier age. 
dat3$Age=as.character(dat3$Age)

for(i in 1:length(dat3$Age)){
  if(dat3$Age[i]==""){
    dat3$respond_age[i]<-"No"
  }
  else{
    dat3$respond_age[i]<-"Yes"
  }
}

#Fixing the age collumn to remove instances where people didn't only enter a number. 
dat3$Age=gsub("30years",30,dat3$Age)
dat3$Age=gsub("33 years",33,dat3$Age)

#Make a new dataframe just for Age, call it dat5
dat5=dat3[!dat3$Age=="",]
dat5$Age=as.numeric(dat5$Age)

#Make a data frame for only those that plan to breastfeed.
breast<-dat3[!dat3$Smoke_breastfeed=="I don't plan to breastfeed",]

#Making suitable for a logistic regression
for(i in 1:length(breast$Smoke_breastfeed)){
  if(breast$Smoke_breastfeed[i]=="Yes"){
    breast$Smoke_breastfeed[i]<-1
  }
  if(breast$Smoke_breastfeed[i]=="No"){
    breast$Smoke_breastfeed[i]<-0
  }
}
breast$Smoke_breastfeed=as.numeric(breast$Smoke_breastfeed)


#Data frame with those that put their Age and planing to breastfeed
breast_with_Age<-breast[breast$Age!="",]

breast_with_Age$Age<-as.numeric(breast_with_Age$Age)
#only 185 participants put their age down and are planning to breastfeed.

```




# Descriptive Statistics:

#### Of those currently using cannabis, how do they take it, what strain, what frequency and why do they use?
```{r,message = F}
#These questions were only available tot those who responded that they are currently smoking. This subset is for that purpose. 
Usage_Smoke_Now<-Usage[Usage$Smoke_Now=="Yes",]

###
#How do they use?
###
a=Check_Counter(Usage_Smoke_Now$Use_Joint)[2]#96%
b=Check_Counter(Usage_Smoke_Now$Use_Oil)[2]#10%
c=Check_Counter(Usage_Smoke_Now$Use_Bong)[2]#0.35%
d=Check_Counter(Usage_Smoke_Now$Use_Edible)[2]#0%
e=Check_Counter(Usage_Smoke_Now$Use_Vaping)[2]#0%

#Visualize
Usage_Stat=data.frame(Usage=c("Joint","Oil","Bong","Edible","Vaping"),Percent=c(a,b,c,d,e))

Usage_Stat=Usage_Stat[order(Usage_Stat$Percent,decreasing = T),]
Usage_Stat$Usage=factor(Usage_Stat$Usage,levels  =c("Joint","Bong","Oil","Edible","Vaping"),ordered = T)

ggplot(Usage_Stat)+
  geom_col(aes(x=Usage,y=Percent,fill=Usage))+scale_y_continuous(limits = c(0,1))

###
#Reasons for use
###
a=Check_Counter(Usage_Smoke_Now$Reason_Nausea_Vomiting)[2]#80%
b=Check_Counter(Usage_Smoke_Now$Reason_Pain)[2]#45%
c=Check_Counter(Usage_Smoke_Now$Reason_Anxiety)[2]#70%
d=Check_Counter(Usage_Smoke_Now$Reason_Sleep)[2]#75%
e=Check_Counter(Usage_Smoke_Now$Reason_Social)[2]#20%
f=Check_Counter(Usage_Smoke_Now$Reason_Other_Check)[2]#10% (only reason listed was that it "opens her appetite")

#Visualize
Usage_Stat=data.frame(Why=c("Nausea/Vomiting","Pain","Anxiety","Sleep","Social","Other"),Percent=c(a,b,c,d,e,f))

Usage_Stat=Usage_Stat[order(Usage_Stat$Percent,decreasing = T),]

Usage_Stat$Usage=factor(Usage_Stat$Why,levels  =c("Nausea/Vomiting","Sleep","Anxiety","Pain","Social","Other"),ordered = T)

ggplot(Usage_Stat)+
  geom_col(aes(x=Usage,y=Percent,fill=Usage))+scale_y_continuous(limits = c(0,1))


#How many checked one of reason sleep, anxiety, pain, nausea?
count=0
for(i in 1:length(Usage_Smoke_Now$Reason_Sleep)){
  if(Usage_Smoke_Now$Reason_Sleep[i]=="Checked" |Usage_Smoke_Now$Reason_Anxiety[i]=="Checked" |Usage_Smoke_Now$Reason_Pain[i]=="Checked" |
     Usage_Smoke_Now$Reason_Nausea_Vomiting[i]=="Checked"|
     Usage_Smoke_Now$Reason_Other[i]=="opens my appetite"){
    count=count+1
     }
}
 
count #95% (19/20) 

```


# Contrasting our data to that of other studies

#### Comparing age data to BORN study sample
Can we trust the conclusions we draw if only 40% of our sample put their age down? I.e. were older or younger people more likely to put thier age or was it random? 
```{r,message = F}
#Lets compare this sample with the statcan 2018 survey of fertility rates in ontario. We will use this to determine if our age sample is reflective of the population as a whole.
#https://www150.statcan.gc.ca/t1/tbl1/en/tv.action?pid=1310041801&pickMembers%5B0%5D=1.7

#Stat can data of fertility rate per 1000 people
# 15 to 19 years: 4.6 
# 20 to 24 years: 25.9
# 25 to 29 years: 73.6
# 30 to 34 years: 108.8
# 35 to 39 years: 61.7
# 40 to 44 years: 13.0
# 45 to 49 years: 0.9

#Convert this data into percentage of people giving birth.
#statCan=c(4.6,25.9,73.6,108.8,61.7,13.0,0.9)
#statCan_percent<-(statCan*1000/sum(statCan*1000))*100
BORN_percent<-c(1.9,10.2,26.9,37.3,19.5,4.3)


#Vectors containing the Age groups of interest (lower and upper range)
low=c(10,20,25,30,35,40)
high=c(19,24,29,34,39,50)

#Calculate the percentage of people giving birth in each statcan age cohort for OUR data.
our_percent=c()
for(i in 1:length(low)){
  our_percent[i]<-agePercent(low[i],high[i],dat5$Age)
}

#Age cohorts for x axis.
xLevel=factor(c("<20","20-24","25-29","30-34","35-39","≥40"),levels=c("<20","20-24","25-29","30-34","35-39","≥40"))


#Data frame containing our data and stat can data.
Age_dat=data.frame("Percent"=append(BORN_percent,our_percent),"Age"=rep(xLevel,2),"Sample"=rep(c("BORN data","Study sample"),each=6))

#Order Factor
Age_dat$Sample<-factor(Age_dat$Sample,levels=c("Study sample","BORN data"))

cb_pallate<-c("#E69F00", "#56B4E9", "#F0E442","#009E73","#CC79A7","#0072B2")

AgeLabel<-paste(round(Age_dat$Percent,1),"%", sep="")
AgeLabel[7]<-"1.0%"

#Visualize

tiff("BORNCompare2.tiff", units="in", width=10, height=6, res=300)
ggplot(Age_dat,aes(x=Age,y=Percent,fill=Sample))+
  geom_col(position="dodge")+
  geom_text(aes(label=AgeLabel, y=Percent,x=Age),position = position_dodge(0.9),vjust=-0.65)+
  
  scale_fill_manual(values = c("#009E73","#56B4E9"))+
  
  
  scale_y_continuous(name="Pregnant women (%)",breaks=c(0,5,10,15,20,25,30,35,40))+
  
  
  scale_x_discrete(name="Age (years)")+
  theme_simple()+
  theme(
    legend.position = c(0.12,0.88),
    legend.background = element_rect(linetype = "solid",size=0.5,colour = "black"),
    legend.title = element_blank())+ 
  guides(fill = guide_legend(reverse = TRUE))
dev.off()


```

![Image](BORNCompare2.tiff)

Figure: Stat can data of fertiliy rates age in ontario in 2018, with our data on those that are currently pregnant. It appears that our survey is fairly representative of the population of Ontario. There is a slight deviation, however, keeping in mind that our sample is only representative of hamilton and individuals in the population will be older at birth, the variation is not unprecedented. Our subset of ~191 individuals appears to be representative of the population.


#### Comparing education data to "All our Babies cohort" (AOB)
```{r,message = F}
#https://bmcpregnancychildbirth.biomedcentral.com/articles/10.1186/1471-2393-13-S1-S2/tables/2

#All our babies cohort: Constructing data frame. 
Education<-c("High school or less", "University/college", "Graduate degree")
n<-c(370 ,2458,528)
data<-c("AOB data", "AOB data", "AOB data")
  
AOB<-data.frame(Education,n,data)
AOB$prop<-AOB$n/sum(AOB$n)

#Making out education in the same structure as that of AOB
unique(dat3$EducationLikeOBS)
dat3$EducationLikeAOB<-dat3$Education
dat3$EducationLikeAOB[dat3$EducationLikeAOB=="college"]<-"University/college"
dat3$EducationLikeAOB[dat3$EducationLikeAOB=="university undergrad degree"]<-"University/college"
dat3$EducationLikeAOB[dat3$EducationLikeAOB=="high school"]<-"High school or less"
dat3$EducationLikeAOB[dat3$EducationLikeAOB=="graduate/professional school"]<-"Graduate degree"
dat3$EducationLikeAOB[dat3$EducationLikeAOB=="trade schooling" ]<-"University/college"
dat3$EducationLikeAOB[dat3$EducationLikeAOB=="elementary/middle school"  ]<-"High school or less"

#What our data looks like in AOB format
tapply(dat3$EducationLikeAOB,dat3$EducationLikeAOB,length)

#Constructing our data frame in the same format as the OBS DAta
Education<-c("High school or less", "University/college", "Graduate degree")
n<-c(90 ,307  , 81  )
data<-c("Study sample", "Study sample", "Study sample")
OurDatLikeAOB<-data.frame(Education,n,data)
OurDatLikeAOB$prop<-OurDatLikeAOB$n/sum(OurDatLikeAOB$n)

#Merging two data frames
Compare2<-rbind(AOB,OurDatLikeAOB)
Compare2$perc<-Compare2$prop*100

Compare2$label<-paste(round(Compare2$perc,1),"%",sep="")


Compare2$Education<-factor(Compare2$Education,levels=c("High school or less", "University/college", "Graduate degree"),ordered=T)


jpeg("AOB_EducationCompare.jpeg", units="in", width=10, height=6, res=300)
ggplot(Compare2)+
  geom_col(aes(x=Education,y = perc,fill=data),position="dodge")+
  geom_text(aes(label=label, y=perc,x=Education,fill=data),position = position_dodge(0.9),vjust=-0.65)+
  
  scale_fill_manual(values = c("#0072B2","#F0E442"))+

  
  scale_y_continuous(name="Pregnant women (%)",breaks=seq(0,100,10),limits=c(0,100))+
  
  
  scale_x_discrete(name="Education")+
  theme_simple()+
  theme(
    legend.position = c(0.15,0.88),
    legend.background = element_rect(linetype = "solid",size=0.5,colour = "black"),
    legend.title = element_blank())
dev.off()


```

![Image](AOB_EducationCompare.jpeg)


#### Comparing income data to "All our Babies cohort" (AOB)
```{r,message = F}
#https://bmcpregnancychildbirth.biomedcentral.com/articles/10.1186/1471-2393-13-S1-S2/tables/2

#All our babies cohort: Constructing data frame. 
Income<-c("<$40,000", "$40,000 - $79,000", "≥$80,000")
n<-c(299 ,717,2236)
data<-c("AOB data", "AOB data", "AOB data")
  
AOB<-data.frame(Income,n,data)
AOB$prop<-AOB$n/sum(AOB$n)

#Making out Income in the same structure as that of AOB
dat3$IncomeLikeAOB<-dat3$Income
unique(dat3$IncomeLikeAOB)
dat3$IncomeLikeAOB[dat3$IncomeLikeAOB=="over $100,000" ]<-"≥$80,000"
dat3$IncomeLikeAOB[dat3$IncomeLikeAOB=="$81,000 - $100,000"]<-"≥$80,000"
dat3$IncomeLikeAOB[dat3$IncomeLikeAOB=="$20,000 - $40,000"]<-"<$40,000"
dat3$IncomeLikeAOB[dat3$IncomeLikeAOB=="$41,000 - $60,000"]<-"$40,000 - $79,000"
dat3$IncomeLikeAOB[dat3$IncomeLikeAOB=="under $20,000" ]<-"<$40,000"
dat3$IncomeLikeAOB[dat3$IncomeLikeAOB=="$61,000 - $80,000"  ]<-"$40,000 - $79,000"

#What our data looks like in AOB format
tapply(dat3$IncomeLikeAOB,dat3$IncomeLikeAOB,length)

#Constructing our data frame in the same format as the OBS DAta
Income<-c("<$40,000", "$40,000 - $79,000", "≥$80,000")
n<-c(94 ,138,246)
data<-c("Study sample", "Study sample", "Study sample")
OurDatLikeAOB<-data.frame(Income,n,data)
OurDatLikeAOB$prop<-OurDatLikeAOB$n/sum(OurDatLikeAOB$n)

#Merging two data frames
Compare2<-rbind(AOB,OurDatLikeAOB)

Compare2$perc<-Compare2$prop*100

Compare2$label<-paste(round(Compare2$perc,1),"%",sep="")

Compare2$Income<-factor(Compare2$Income,levels=c("<$40,000", "$40,000 - $79,000", "≥$80,000"),ordered=T)


jpeg("AOB_IncomeCompare.jpeg", units="in", width=10, height=6, res=300)
ggplot(Compare2)+
  geom_col(aes(x=Income,y = perc,fill=data),position="dodge")+

  geom_text(aes(label=label, y=perc,x=Income,fill=data),position = position_dodge(0.9),vjust=-0.65)+
  
  scale_fill_manual(values = c("#CC79A7","#E69F00"))+
  
  
  scale_y_continuous(name="Pregnant women (%)",breaks=seq(0,100,10),limits=c(0,100))+
  
  
  scale_x_discrete(name="Income")+
  theme_simple()+
  theme(
    legend.position = c(0.15,0.88),
    legend.background = element_rect(linetype = "solid",size=0.5,colour = "black"),
    legend.title = element_blank())
dev.off()

```
![Image](AOB_IncomeCompare.jpeg)

#### The correlation between income and SES 
These statistics were needed to demonstrate that income and eduction were correlated and could not be co-exist in the multivariable regression.
```{r,message = F}
#Making ordinal vectors. 

#Education
dat3$Education_Pooled_Ordinal<-dat3$Education_Pooled

dat3$Education_Pooled_Ordinal[dat3$Education_Pooled_Ordinal=="Elementary/Highschool"]<-1
dat3$Education_Pooled_Ordinal[dat3$Education_Pooled_Ordinal=="College/Tradeschool"]<-2
dat3$Education_Pooled_Ordinal[dat3$Education_Pooled_Ordinal=="University/Gradschool"]<-3
dat3$Education_Pooled_Ordinal<-as.numeric(dat3$Education_Pooled_Ordinal)

#Income 
dat3$Income_Pooled_Ordinal<-dat3$Income_Pooled

dat3$Income_Pooled_Ordinal[dat3$Income_Pooled_Ordinal=="0-40"]<-1
dat3$Income_Pooled_Ordinal[dat3$Income_Pooled_Ordinal=="40-100"]<-2
dat3$Income_Pooled_Ordinal[dat3$Income_Pooled_Ordinal=="100+"]<-3
dat3$Income_Pooled_Ordinal<-as.numeric(dat3$Income_Pooled_Ordinal)

#Performing spearman rank correlation
cor.test(dat3$Education_Pooled_Ordinal,dat3$Income_Pooled_Ordinal,method = 'spearman')
#Table of education and income
table(dat3$Education_Pooled,dat3$Income_Pooled)
```

# Logistic regressions
In this section I determine what demographic factors are associated with an individuals odds of consuming cannabis while pregnant. 

#### Multivariable Odds Ratio's for **"Cannabis consumption at some point in pregnancy"**. 
```{r,message = F,results='hide'}
#Logistic regression
fit_1<-glm(Ever_Smoke_While_Preg~Education_Pooled+Relationship_Status_Pooled+Partner_Smoke, family = binomial,data=dat3)
summary(fit_1)
  Odds(summary(fit_1)$coef[,1]) #Odds ratio
  Odds(confint(fit_1)) #Confidence interval
```

#### Univariable Odds Ratio's for **"Cannabis consumption at some point in pregnancy"**. 
```{r,message = F,results='hide'}
#Fitting education
dat3$Education_Pooled<-as.factor(dat3$Education_Pooled)
dat3$Education_Pooled<-relevel(dat3$Education_Pooled,ref="University/Gradschool")#Setting university/gradschool as reference
fit_1<-glm(Ever_Smoke_While_Preg~Education_Pooled, family = binomial,data=dat3)
summary(fit_1) #
  Odds(summary(fit_1)$coef[,1])  #Odds ratio
Odds(confint(fit_1))#Confidence interval

#Fitting Income
dat3$Income_Pooled<-as.factor(dat3$Income_Pooled)
dat3$Income_Pooled<-relevel(dat3$Income_Pooled,ref="100+")#Setting income as 100,000+ as reference
fit_1<-glm(Ever_Smoke_While_Preg~Income_Pooled, family = binomial,data=dat3)
summary(fit_1) #
  Odds(summary(fit_1)$coef[,1]) #Odds ratio
Odds(confint(fit_1))#Confidence interval

#Fitting Relationship status
fit_1<-glm(Ever_Smoke_While_Preg~Relationship_Status_Pooled, family = binomial,data=dat3)
summary(fit_1) # 
  Odds(summary(fit_1)$coef[,1]) #Odds ratio
  Odds(confint(fit_1))#Confidence interval

  #Fitting Partner cannabis consumption
fit_1<-glm(Ever_Smoke_While_Preg~Partner_Smoke, family = binomial,data=dat3)
summary(fit_1) # 
  Odds(summary(fit_1)$coef[,1]) #Odds ratio
  Odds(confint(fit_1))#Confidence interval
  
  #Fitting Age
fit_1<-glm(Ever_Smoke_While_Preg~Age, family = binomial,data=dat5)
summary(fit_1) #
  Odds(summary(fit_1)$coef[,1]) #Odds ratio
  Odds(confint(fit_1))#Confidence interval



```


#### Univariable Odds Ratio's for **"Current cannabis consumption"** in pregnancy. 
```{r,message = F,results='hide'}
#Fitting education
fit_1<-glm(Smoke_Now~Education_Pooled, family = binomial,data=dat3)
summary(fit_1) #Very significant.
Odds(summary(fit_1)$coef[,1])  #Odds ratio
Odds(confint(fit_1))#Confidence interval

#Fitting income
fit_1<-glm(Smoke_Now~Income_Pooled, family = binomial,data=dat3)
summary(fit_1) #Very significant.
Odds(summary(fit_1)$coef[,1]) #Odds ratio
Odds(confint(fit_1))#Confidence interval

#Fitting relationship status
fit_2<-glm(Smoke_Now~Relationship_Status_Pooled, family = binomial,data=dat3)
summary(fit_2) #Significant
Odds(summary(fit_2)$coef[,1])  #Odds ratio
Odds(confint(fit_2))#Confidence interval

#Fitting partner cannabis consumption
fit_3<-glm(Smoke_Now~Partner_Smoke, family = binomial,data=dat3)
summary(fit_3) #Significant
Odds(summary(fit_3)$coef[,1]) #Odds ratio
Odds(confint(fit_3))#Confidence interval

#Fitting age
dat3$Age<-as.numeric(dat3$Age)
fit_4<-glm(Smoke_Now~Age, family = binomial,data=dat3)
summary(fit_4) # not significant. 
Odds(summary(fit_4)$coef[,1]) #Odds ratio
Odds(confint(fit_4))#Confidence interval
```


#### Univariable Odds Ratio's for **"Intent to consume cannabis while breastfeeding"**. 
```{r,message = F,results='hide'}
breast$Education_Pooled<-as.factor(breast$Education_Pooled)
breast$Education_Pooled<-relevel(breast$Education_Pooled,"University/Gradschool")

breast$Income_Pooled<-as.factor(breast$Income_Pooled)
breast$Income_Pooled<-relevel(breast$Income_Pooled,"100+")

fit_1<-glm(Smoke_breastfeed~Education_Pooled, family = binomial,data=breast)
summary(fit_1) #Very significant.
Odds(summary(fit_1)$coef[,1]) 
Odds(confint(fit_1))

fit_1<-glm(Smoke_breastfeed~Income_Pooled, family = binomial,data=breast)
summary(fit_1) #Not significant
Odds(summary(fit_1)$coef[,1]) 
Odds(confint(fit_1))


fit_2<-glm(Smoke_breastfeed~Relationship_Status_Pooled, family = binomial,data=breast)
summary(fit_2) #Not significant.
Odds(summary(fit_2)$coef[,1]) 
Odds(confint(fit_2))

fit_3<-glm(Smoke_breastfeed~Partner_Smoke, family = binomial,data=breast)
Odds(summary(fit_3)$coef[,1]) 
Odds(confint(fit_3))

fit_4<-glm(Smoke_breastfeed~as.numeric(Age), family = binomial,data=breast)
summary(fit_4) # not significant. 
Odds(summary(fit_4)$coef[,1]) 

Odds(confint(fit_4))

```


# Visualizing cannabis consumption at some point in pregnancy.
A Visualization of the significant independent variables associated with cannabis consumption at some point in pregnancy.


#### Creating a visualization data frame.
```{r,message = F}
#Construction data frame of estimates and confidence intervals. 
a<-ConfIntProportion2(dat3$Ever_Smoke_While_Preg[dat3$Education_Pooled=="Elementary/Highschool"&dat3$Partner_Smoke=="No"],"Elementary/Highschool","No")

b<-ConfIntProportion2(dat3$Ever_Smoke_While_Preg[dat3$Education_Pooled=="College/Tradeschool"&dat3$Partner_Smoke=="No"],"College/Tradeschool","No")

c<-ConfIntProportion2(dat3$Ever_Smoke_While_Preg[dat3$Education_Pooled=="University/Gradschool"&dat3$Partner_Smoke=="No"],"University/Gradschool","No")

d<-ConfIntProportion2(dat3$Ever_Smoke_While_Preg[dat3$Education_Pooled=="Elementary/Highschool"&dat3$Partner_Smoke=="Yes"],"Elementary/Highschool","Yes")

e<-ConfIntProportion2(dat3$Ever_Smoke_While_Preg[dat3$Education_Pooled=="College/Tradeschool"&dat3$Partner_Smoke=="Yes"],"College/Tradeschool","Yes")

f<-ConfIntProportion2(dat3$Ever_Smoke_While_Preg[dat3$Education_Pooled=="University/Gradschool"&dat3$Partner_Smoke=="Yes"],"University/Gradschool","Yes")

Ever_Vis<-rbind(a,b,c,d,e,f)
Ever_Vis<-Ever_Vis[Ever_Vis$varname=="1",]
Ever_Vis$Fraction<-paste(Ever_Vis$numerator,"/",Ever_Vis$denominator,sep="") #Making a vector of fractions
Ever_Vis$percent<-as.numeric(Ever_Vis$percent)
Ever_Vis$upper<-as.numeric(Ever_Vis$upper)
Ever_Vis$lower<-as.numeric(Ever_Vis$lower)

Ever_Vis$Education<-factor(Ever_Vis$Education,levels=c("University/Gradschool","College/Tradeschool", "Elementary/Highschool"),ordered = T)

```

#### Bootstrapping confidence intervals for figure.

The models performed do not fit parameter estimates for the joined effect of two variables in the multivariate regression, as model selection did not take place. To demonstrate the combined effect of *partner cannabis consumption* and *education* on *cannabis consumption at some point in pregnancy*, parametric confidence intervals were obtained by randomly resampling a binomial distribution (with n equal to the our sample size) 100,000 times. The inner 95% of the distribution of parameter estimates determines the confidence interval.
```{r,message = F}
#Bootstrapping confidence intervals
Ever_Vis$denominator<-as.numeric(Ever_Vis$denominator)
Ever_Vis$percent<-as.numeric(Ever_Vis$percent)
Booter<-list()
for(i in 1:length(Ever_Vis$denominator)){
 
preholder <- rbinom(100000,Ever_Vis$denominator[i],Ever_Vis$percent[i]/100) #Sampling binomial distribution 1000000 times for with the proportion set to each parameter value in our data. 

  holder<-preholder/Ever_Vis$denominator[i] #Storing data
  
  #Building data frame
 Ever_Vis$lowerB[i]<- quantile(holder,probs = 0.025)*100  #Determining confidence interval for each parameter in loop
 Ever_Vis$upperB[i]<- quantile(holder,probs = 0.975) *100
}

#Confidence intervals.
Ever_Vis
```


#### Visualizing data
```{r,message = F}
#plot of model predictions
EverUse<-ggplot(Ever_Vis,aes(x=Partner,fill=Education))+
 geom_col(aes(y=percent),position = position_dodge(1))+
  geom_linerange(aes(ymin=lowerB,ymax=upperB),position=position_dodge(1),show.legend = F)+
  geom_text(aes(label=Fraction, y=percent),position = position_dodge(1),hjust=-0.25,vjust=-0.65,size=4)+
  
    scale_y_continuous(limits = c(-2,60),breaks = seq(0,60,5))+
         labs(x="Partner cannabis consumption", fill="Education",y="Proportion (%)")+

  scale_fill_manual(values=cb_pallate,labels=c("University/graduate school","College/trade school", "Elementary/high school" ))+

  theme_simple()+

  theme(#axis.title.y = element_blank(),
      #  axis.title.x = element_text(),
        legend.position = c(0.25,0.85),
        legend.background = element_rect(linetype = "solid",size=0.5,colour = "black")
        )
  #labs(title="Cannabis Use at Some\nPoint in Pregnancy")


tiff("EverUseNew.tiff", units="in", width=8, height=6, res=300)
EverUse
dev.off()

```

![Image](EverUseNew.tiff)

# Descriptive statistics used in Table 1 
The following code creates table 1, and write the file to a csv file to be opened in excel. 
```{r,message = F}
#Ever use during pregnancy
a<-ConfIntProportion3(dat3$Ever_Smoke_While_Preg,dat3$Education_Pooled)
b<-ConfIntProportion3(dat3$Ever_Smoke_While_Preg,dat3$Income_Pooled)
c<-ConfIntProportion3(dat3$Ever_Smoke_While_Preg,dat3$Partner_Smoke)
d<-ConfIntProportion3(dat3$Ever_Smoke_While_Preg,dat3$Relationship_Status_Pooled)

a1<-rbind(a,b,c,d)

#Current use during pregnancy
a<-ConfIntProportion3(dat3$Smoke_Now,dat3$Education_Pooled)
b<-ConfIntProportion3(dat3$Smoke_Now,dat3$Income_Pooled)
c<-ConfIntProportion3(dat3$Smoke_Now,dat3$Partner_Smoke)
d<-ConfIntProportion3(dat3$Smoke_Now,dat3$Relationship_Status_Pooled)

a2<-rbind(a,b,c,d)


# Use While Breastfeeding 
a<-ConfIntProportion3(breast$Smoke_breastfeed,breast$Education_Pooled)
b<-ConfIntProportion3(breast$Smoke_breastfeed,breast$Income_Pooled)
c<-ConfIntProportion3(breast$Smoke_breastfeed,breast$Partner_Smoke)
d<-ConfIntProportion3(breast$Smoke_breastfeed,breast$Relationship_Status_Pooled)

a3<-rbind(a,b,c,d)

FinalTable<-cbind(a1,a2,a3)


write.csv(FinalTable,file = "Automate_Table2.csv")


#Age Stats

tapply(dat5$Age,as.factor(dat5$Ever_Smoke_While_Preg),mean,na.rm=T)
tapply(dat5$Age,as.factor(dat5$Ever_Smoke_While_Preg),sd,na.rm=T)

tapply(dat5$Age,as.factor(dat5$Smoke_Now),mean,na.rm=T)
tapply(dat5$Age,as.factor(dat5$Smoke_Now),sd,na.rm=T)

tapply(breast_with_Age$Age,as.factor(breast_with_Age$Smoke_breastfeed),mean,na.rm=T)
tapply(breast_with_Age$Age,as.factor(breast_with_Age$Smoke_breastfeed),sd,na.rm=T)

sum(
length(dat3$Ever_Smoke_While_Preg[dat3$Ever_Smoke_While_Preg==0]),
length(dat3$Ever_Smoke_While_Preg[dat3$Ever_Smoke_While_Preg==1])
)

sum(
length(dat3$Smoke_Now[dat3$Smoke_Now==0]),
length(dat3$Smoke_Now[dat3$Smoke_Now==1])
)

sum(
  length(breast$Smoke_breastfeed[breast$Smoke_breastfeed==0]),
length(breast$Smoke_breastfeed[breast$Smoke_breastfeed==1])
)

```












